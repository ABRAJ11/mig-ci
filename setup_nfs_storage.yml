---
- name: Create nfs server instance
  hosts: localhost
  roles:
    - nfs_server

- name: Add OCP EC2 instance host to in memory inventory
  hosts: localhost
  tasks:
    - add_host:
        name: "{{ nfs_server_ip }}"
        group: ocp_nfs_servers
        ansible_user: "{{ ec2_user }}"
        ansible_ssh_private_key_file: "{{ ec2_private_key_file }}"
    
    - name: Template the PV reasources
      template:
        src: "{{ playbook_dir }}/roles/ocp_setup_nfs/templates/pv.yml.j2"
        dest: "{{ playbook_dir}}/pv.yml"
  vars:
    ec2_user: "ec2-user"
    ec2_private_key_file: "../keys/ci.pem"
  tags:
    - always

- name: Setup OCP NFS storage
  hosts: ocp_nfs_servers
  tasks:
  vars:
    ansible_ssh_common_args: -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
  roles:
    - ocp_setup_nfs
  environment:
    PATH: "{{ ansible_env.PATH }}:~/bin"
